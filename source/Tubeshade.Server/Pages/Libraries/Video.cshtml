@page "~/Libraries/{libraryId:guid}/Videos/{videoId:guid}/{handler?}"
@model Video
@{
    ViewData["Title"] = Model.Entity.Name;
}

@section Navigation
{
    @await Html.PartialAsync("_LibraryNavigation", Model.Library)
}

<video id="main-video" controls playsinline preload="metadata" width="100%"
       poster="@Url.Action("GetThumbnail", "Videos", new { version = "1.0", id = Model.VideoId })">

    @foreach (var file in Model.Files)
    {
        <source
            src="@Url.Action("GetFile", "Videos", new { version = "1.0", id = Model.VideoId, fileId = file.Id })"
            type="video/@file.Type.Name"/>
    }

    <track
        src="@Url.Action("GetSubtitles", "Videos", new { version = "1.0", id = Model.VideoId })"
        label="English" kind="subtitles" srclang="en" default/>
    <track
        src="@Url.Action("GetChapters", "Videos", new { version = "1.0", id = Model.VideoId })"
        kind="chapters" srclang="en" default/>
</video>

<section id="video-controls" class="row row-cols-sm-2 row-cols-xl-3">
    <div class="col-12">
        <div class="input-group">
            <label for="sources" class="input-group-text">Resolution</label>
            <select id="sources" class="form-control form-select">
                @foreach (var file in Model.Files)
                {
                    <option
                        value="@Url.Action("GetFile", "Videos", new { version = "1.0", id = Model.VideoId, fileId = file.Id })">
                        @(file.Height)@@@(file.Framerate)
                    </option>
                }
            </select>
        </div>
    </div>

    <div class="col-12">
        <div class="input-group">
            <label for="playback-rate-input" class="input-group-text">Speed</label>
            <input id="playback-rate-input" class="form-control" type="number" min="0" step="0.25"
                   value="@Model.PlaybackSpeed"/>
        </div>
    </div>

    <div id="chapter-marker-div" hidden class="col-12 col-sm-12">
        <div class="input-group">
            <label for="chapter-markers" class="input-group-text">Chapter</label>
            <select id="chapter-markers" class="form-control form-select"></select>
        </div>
    </div>
</section>

<h2>@Model.Entity.Name</h2>
<h4>
    <a asp-page="/Libraries/Channel" asp-route-libraryId="@Model.LibraryId" asp-route-channelId="@Model.Channel.Id">
        @Model.Channel.Name
    </a>
</h4>

<a href="@Model.Entity.ExternalUrl">Original</a>

<section id="video-description">
    @foreach (var paragraph in Model.Entity.Description.Split(["\r\n","\n"], StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
    {
        <p>
            @paragraph
        </p>
    }
</section>

@section Scripts
{
    <script>
        const video = document.querySelector("#main-video");
        video.playbackRate = @Model.PlaybackSpeed;

        const sourcesSelector = document.querySelector("#sources");

        // set the selected option to the source currently selected by the browser
        for (let index = 0; index < sourcesSelector.options.length; index++) {
            if (video.currentSrc.endsWith(sourcesSelector.options[index].value)) {
                sourcesSelector.selectedIndex = index;
            }
        }

        sourcesSelector.addEventListener("change", onSourcesSelectorChanged, false);

        function onSourcesSelectorChanged() {
            const currentTime = video.currentTime;
            video.src = sourcesSelector.options[sourcesSelector.selectedIndex].value;
            video.currentTime = currentTime;
            if (!video.paused && !video.ended) {
                video.play();
            }
        }

        const playbackRateInput = document.querySelector("#playback-rate-input");
        playbackRateInput.addEventListener("change", onPlaybackSpeedInputChange, false);
        video.addEventListener("ratechange", onVideoRateChange, false);

        function onPlaybackSpeedInputChange() {
            if (video.playbackRate !== playbackRateInput.value) {
                video.playbackRate = playbackRateInput.value;
            }
        }

        function onVideoRateChange() {
            if (playbackRateInput.value !== video.playbackRate) {
                playbackRateInput.value = video.playbackRate;
            }
        }

        const chapterTrack = video.querySelector('track[kind="chapters"]');
        const chapters = document.querySelector("#chapter-markers");
        const chaptersSection = document.querySelector("#chapter-marker-div");

        chapterTrack.addEventListener("load", onTrackLoad, false);
        chapterTrack.addEventListener("loaded", onTrackLoad, false);

        function onTrackLoad() {
            chaptersSection.removeAttribute("hidden");

            for (const cue of chapterTrack.track.cues) {
                createMarker(cue);
            }
        }

        const markerStartTimeAttributeName = "data-start-time";

        function createMarker(cue) {
            const option = document.createElement("option");
            let timestamp = new Date(cue.startTime * 1000).toISOString().slice(11, 19);
            if (timestamp.startsWith("00:")){
                timestamp = timestamp.slice(3);
            }

            option.value = cue.startTime;
            option.innerHTML = `${timestamp} - ${cue.text}`;
            option.setAttribute(markerStartTimeAttributeName, cue.startTime);
            option.addEventListener("click", onClickMarker);

            chapters.appendChild(option);
        }

        function onClickMarker(event) {
            video.currentTime = event.target.getAttribute(markerStartTimeAttributeName);
        }
    </script>
}
