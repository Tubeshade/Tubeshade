@page "~/Libraries/{libraryId:guid}/Videos/{videoId:guid}/{handler?}"
@using Tubeshade.Server.Pages.Shared
@model Video
@{
    ViewData["Title"] = Model.Entity.Name;
}

@section Navigation
{
    @await Html.PartialAsync("_LibraryNavigation", Model.Library)
}

<video id="main-video" controls playsinline preload="metadata" width="100%"
       poster="@Url.Action("GetThumbnail", "Videos", new { version = "1.0", id = Model.VideoId })">

    @foreach (var file in Model.Files)
    {
        <source
            src="@Url.Action("GetFile", "Videos", new { version = "1.0", id = Model.VideoId, fileId = file.Id })"
            type="video/@file.Type.Name"/>
    }

    <track
        src="@Url.Action("GetSubtitles", "Videos", new { version = "1.0", id = Model.VideoId })"
        label="English" kind="subtitles" srclang="en" default/>
    <track
        src="@Url.Action("GetChapters", "Videos", new { version = "1.0", id = Model.VideoId })"
        kind="chapters" srclang="en" default/>
    @if (Model.HasSponsorBlockSegments)
    {
        <track
            src="@Url.Action("GetSponsorBlockSegments", "Videos", new { version = "1.0", id = Model.VideoId })"
            kind="metadata" srclang="en" label="SponsorBlock" default/>
    }
</video>

<section id="video-controls" class="row row-cols-sm-2 row-cols-xl-3">
    <div class="col-12">
        <div class="input-group">
            <label for="sources" class="input-group-text">Resolution</label>
            <select id="sources" class="form-control form-select">
                @foreach (var file in Model.Files)
                {
                    <option
                        value="@Url.Action("GetFile", "Videos", new { version = "1.0", id = Model.VideoId, fileId = file.Id })">
                        @(file.Height)@@@(file.Framerate)
                    </option>
                }
            </select>
        </div>
    </div>

    <div class="col-12">
        <div class="input-group">
            <label for="playback-rate-input" class="input-group-text">Speed</label>
            <input id="playback-rate-input" class="form-control" type="number" min="0" step="0.25"
                   value="@Model.PlaybackSpeed"/>
        </div>
    </div>

    <div id="chapter-marker-div" hidden class="col-12 col-sm-12">
        <div class="input-group">
            <label for="chapter-markers" class="input-group-text">Chapter</label>
            <select id="chapter-markers" class="form-control form-select"></select>
        </div>
    </div>
</section>

<h2>@Model.Entity.Name</h2>
<h4>
    <a asp-page="/Libraries/Channels/Channel" asp-route-libraryId="@Model.LibraryId" asp-route-channelId="@Model.Channel.Id">
        @Model.Channel.Name
    </a>
</h4>

<a href="@Model.Entity.ExternalUrl">Original</a>

<section id="video-description">
    @foreach (var paragraph in Model.Entity.Description.Split(["\r\n", "\n"], StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
    {
        <p>
            @paragraph
        </p>
    }
</section>

@section Scripts
{
    <script>
        const video = document.querySelector("#main-video");
        video.playbackRate = @Model.PlaybackSpeed;

        if ("mediaSession" in navigator) {
            // since thumbnail endpoint requires authentication, the artwork source cannot be simply set to the url of the thumbnail
            // we need to fetch it within the page context, and encode it into a data url
            fetch("@Url.ActionLink("GetThumbnail", "Videos", new { version = "1.0", id = Model.VideoId })")
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = URL.createObjectURL(blob);
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: @Html.Raw(Model.Entity.Name.ToJson()),
                        album: @Html.Raw(Model.Library.Name.ToJson()),
                        artist: @Html.Raw(Model.Channel.Name.ToJson()),
                        artwork: [
                            {
                                src: blobUrl,
                                type: "image/jpeg",
                                sizes: "512x512"
                            }
                        ],
                    });
                });

            navigator.mediaSession.setActionHandler("play", () => video.play());
            navigator.mediaSession.setActionHandler("pause", () => video.pause());
            navigator.mediaSession.setActionHandler("stop", () => video.pause());
            navigator.mediaSession.setActionHandler("seekforward", (event) => {
                const skipTime = event.seekOffset || 10;
                video.currentTime = Math.min(video.currentTime + skipTime, video.duration);
            });
            navigator.mediaSession.setActionHandler("seekbackward", (event) => {
                const skipTime = event.seekOffset || 10;
                video.currentTime = Math.max(video.currentTime - skipTime, 0);
            });
            navigator.mediaSession.setActionHandler("seekto", (event) => {
                video.currentTime = event.seekTime;
            });
        }

        const sourcesSelector = document.querySelector("#sources");

        // set the selected option to the source currently selected by the browser
        for (let index = 0; index < sourcesSelector.options.length; index++) {
            if (video.currentSrc.endsWith(sourcesSelector.options[index].value)) {
                sourcesSelector.selectedIndex = index;
            }
        }

        sourcesSelector.addEventListener("change", onSourcesSelectorChanged, false);

        function onSourcesSelectorChanged() {
            const currentTime = video.currentTime;
            const paused = video.paused;

            video.src = sourcesSelector.options[sourcesSelector.selectedIndex].value;
            video.currentTime = currentTime;
            if (!paused) {
                video.play();
            }
        }

        const playbackRateInput = document.querySelector("#playback-rate-input");
        playbackRateInput.addEventListener("change", onPlaybackSpeedInputChange, false);
        video.addEventListener("ratechange", onVideoRateChange, false);

        function onPlaybackSpeedInputChange() {
            if (video.playbackRate !== playbackRateInput.value) {
                video.playbackRate = playbackRateInput.value;
            }
        }

        function onVideoRateChange() {
            if (playbackRateInput.value !== video.playbackRate) {
                playbackRateInput.value = video.playbackRate;
            }
        }

        const chaptersTrack = video.querySelector('track[kind="chapters"]');
        const chapters = document.querySelector("#chapter-markers");
        const chaptersSection = document.querySelector("#chapter-marker-div");

        chaptersTrack.addEventListener("load", onChaptersTrackLoad, false);
        chaptersTrack.addEventListener("loaded", onChaptersTrackLoad, false);

        function onChaptersTrackLoad() {
            chaptersSection.removeAttribute("hidden");

            for (const cue of chaptersTrack.track.cues) {
                createMarker(cue);
            }

            chapters.addEventListener("change", function (event) {
                video.currentTime = event.target.value;
            });
        }

        function createMarker(cue) {
            let timestamp = new Date(cue.startTime * 1000).toISOString().slice(11, 19);
            if (timestamp.startsWith("00:")) {
                timestamp = timestamp.slice(3);
            }

            const option = document.createElement("option");
            option.value = cue.startTime;
            option.innerHTML = `${timestamp} - ${cue.text}`;
            chapters.appendChild(option);
        }

        const sponsorBlockTrack = video.querySelector('track[kind="metadata"][label="SponsorBlock"]');
        if (sponsorBlockTrack !== null) {
            sponsorBlockTrack.addEventListener("load", onSponsorBlockTrackLoad, false);
            sponsorBlockTrack.addEventListener("loaded", onSponsorBlockTrackLoad, false);
        }

        function onSponsorBlockTrackLoad() {
            sponsorBlockTrack.track.addEventListener("cuechange", function (event) {
                const activeCues = event.target.activeCues;

                if (activeCues.length === 1) {
                    const cue = activeCues[0];
                    console.log("Single active cue", cue);
                    if (cue.text !== "filler") {
                        video.currentTime = cue.endTime;
                    }
                } else {
                    console.debug("Zero or multiple active cues", activeCues);
                }
            });
        }
    </script>
}
