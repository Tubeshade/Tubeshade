@page "~/Libraries/{libraryId:guid}/Videos/{videoId:guid}/{handler?}"
@model Video
@{
    ViewData["Title"] = Model.Entity.Name;
}

@section Navigation
{
    @await Html.PartialAsync("_LibraryNavigation", Model.Library)
}

<video id="main-video" controls playsinline preload="metadata" width="100%"
       poster="@Url.Action("GetThumbnail", "Videos", new { version = "1.0", id = Model.VideoId })">

    @foreach (var file in Model.Files)
    {
        <source
            src="@Url.Action("GetFile", "Videos", new { version = "1.0", id = Model.VideoId, fileId = file.Id })"
            type="video/@file.Type.Name"/>
    }

    <track
        src="@Url.Action("GetSubtitles", "Videos", new { version = "1.0", id = Model.VideoId })"
        label="English" kind="subtitles" srclang="en" default/>
    <track
        src="@Url.Action("GetChapters", "Videos", new { version = "1.0", id = Model.VideoId })"
        kind="chapters" srclang="en" default/>
</video>

<h2>@Model.Entity.Name</h2>
<h4><a asp-page="/Channels/Channel" asp-route-channelId="@Model.Channel.Id">@Model.Channel.Name</a></h4>

<a href="@Model.Entity.ExternalUrl">Original</a>

<section id="chapter-markers">

</section>

<section id="source-selections">
    <select id="sources">
        @foreach (var file in Model.Files)
        {
            <option
                value="@Url.Action("GetFile", "Videos", new { version = "1.0", id = Model.VideoId, fileId = file.Id })">
                @(file.Height)@@@(file.Framerate)
            </option>
        }
    </select>
</section>

<section id="video-description">
    @foreach (var paragraph in Model.Entity.Description.Split(["\r\n",], StringSplitOptions.None))
    {
        @paragraph
        <br/>
    }
</section>

@section Scripts
{
    <script>
        const video = document.querySelector("#main-video");
        video.playbackRate = @Model.PlaybackSpeed;

        const sourcesSelector = document.querySelector("#sources");

        // set the selected option to the source currently selected by the browser
        for (let index = 0; index < sourcesSelector.options.length; index++) {
            if (video.currentSrc.endsWith(sourcesSelector.options[index].value)) {
                sourcesSelector.selectedIndex = index;
            }
        }

        sourcesSelector.addEventListener("change", onSourcesSelectorChanged, false);

        function onSourcesSelectorChanged() {
            const currentTime = video.currentTime;
            video.src = sourcesSelector.options[sourcesSelector.selectedIndex].value;
            video.currentTime = currentTime;
            video.play();
        }

        const chapterTrack = video.querySelector('track[kind="chapters"]');
        const chapters = document.querySelector("#chapter-markers");

        chapterTrack.addEventListener("load", onTrackLoad, false);
        chapterTrack.addEventListener("loaded", onTrackLoad, false);

        function onTrackLoad() {
            for (const cue of chapterTrack.track.cues) {
                createMarker(cue);
            }
        }

        const markerStartTimeAttributeName = "data-start-time";

        function createMarker(cue) {
            const element = document.createElement("span");
            element.innerHTML = cue.text;
            element.setAttribute(markerStartTimeAttributeName, cue.startTime);
            element.addEventListener("click", onClickMarker);

            chapters.appendChild(element);
        }

        function onClickMarker(event) {
            video.currentTime = event.target.getAttribute(markerStartTimeAttributeName);
        }
    </script>
}
